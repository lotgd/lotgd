<div {{ attributes.defaults(
    stimulus_controller('tooltip'),
) }}>
    <!-- Loading -->
    <div data-loading="show" class="modal-backdrop">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="row lotgd-stage">
        <div class="col-3 bg-primary-subtle lotgd-stage-actions px-3">
            <div data-loading="">
                Loading...
            </div>
            <ul data-loading="hide" class="nav flex-column py-3">
                {% if this.stage.actionGroups["lotgd.actionGroup.empty"] is defined %}
                    {% for action in this.stage.actionGroups["lotgd.actionGroup.empty"].actions %}
                        <twig:Action :action="action" :character="character" />
                    {% endfor %}
                {% endif %}

                {% for actionGroup in this.stage.actionGroups|filter(g => g.id not in ["lotgd.actionGroup.empty", "lotgd.actionGroup.hidden"])|sort((a, b) => a.weight <=> b.weight) %}
                    <li class="nav-item lotgd-stage-action-group">
                        {{ actionGroup.title }} {{ actionGroup.weight }}
                    </li>

                    {% for action in actionGroup.actions %}
                        <li class="nav-item lotgd-stage-action d-flex justify-content-between align-items-start">
                            <a class="nav-link"
                               {{ live_action("takeAction", {
                                   "actionId": action.id,
                               }) }}
                            >{{ action.title }}</a>

                            {% if is_granted("ROLE_DEBUG") %}
                                {%- set tooltip -%}
                                    <div class="p-2 text-white text-start">
                                        <dl>
                                            <dt>id</dt>
                                            <dd>{{ action.id }}</dd>
                                            <dt>reference</dt>
                                            <dd>{{ action.reference ?? 'null' }}</dd>
                                            <dt>parameters</dt>
                                            <dd class="font-monospace preserve-breaks">{% if action.parameters|length == 0 %}{}{% else %}{
                                                {% for param, value in action.parameters -%}
                                                    &nbsp;- {{ param }}: {{ value|stringify }},
                                                {% endfor -%}
                                                }{% endif %}</dd>
                                        </dl>
                                    </div>
                                {%- endset -%}
                                <span
                                    class="btn btn-outline-info"
                                    data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="{{ tooltip|escape("html") }}"
                                >!</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>

        <div class="col-6 p-3 lotgd-stage-scene">
            <h2>{{ this.stage.title }}</h2>

            {{ this.stage.description|parse({
                "character": character,
            }|merge(this.stage.context))|raw }}

            {# Attachments #}
            {% for attachment in this.stage.attachments %}
                {% if is_granted("ROLE_DEBUG") and app.environment == "dev" %}
                    <twig:Debug title="Attachment" name="{{ attachment.attachment.name }}">
                        {# {{ dump(attachment) }} #}
                    </twig:Debug>
                {% endif %}

                {% try %}
                    {{ component(attachment.attachment.attachmentClass, {
                        "id": randomId(),
                        "character": character,
                        "stage": stage,
                        "config": attachment.config,
                    }|merge(attachment.data)) }}
                {% catch %}
                    {% if is_granted("ROLE_DEBUG") %}
                        <twig:Debug title="Attachment" name="{{ attachment.attachment.name }}">
                            This attachment is faulty: {{ e.message }}

                            {% if app.environment == "dev" %}
                                {# {{ dump(e) }} #}
                            {% endif %}
                        </twig:Debug>
                    {% endif %}
                {% endcatch %}

            {% endfor %}
        </div>

        <div class="col-3 bg-primary-subtle p-3">
            <table class="table small">
                {% for row in charStats %}
                    {% if row|length == 1 %}
                        <tr>
                            <th class="bg-primary text-white" scope="colgroup" colspan="2">{{ row[0] }}</th>
                        </tr>
                    {% else %}
                        <tr>
                            <th scope="row">{{ row[0] }}</th>
                            <td>
                                {% if row|length == 2 %}
                                    {{ row[1] }}
                                {% else %}
                                    <twig:Bootstrap:Progress :current="row[1]" :max="row[2]" displayMax displayCurrent colored />
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </table>
        </div>
    </div>
</div>